<section class="stack-md">
  @if (project(); as projectDetail) {
    <div class="detail-grid">
      <article class="card pad stack-md project-summary-card">
        <div class="row row-refresh project-summary-head">
          <div>
            <h1 class="title">{{ projectDetail.title }}</h1>
          </div>
          <div class="project-actions">
            <button class="btn ghost sm" type="button" (click)="toggleMeta()">
              {{ 'project.summary.additional.show' | translate }}
            </button>
            <button class="btn ghost sm" type="button" (click)="openProjectAnalysis()">
              {{ 'project.analysis.open' | translate }}
            </button>
            @if (currentUserId() === projectDetail.ownerId) {
              <button class="btn ghost sm" type="button" (click)="openMemberListModal()">
                {{ 'project.members.manage' | translate }}
              </button>
            }
          </div>
        </div>
        <p class="muted">{{ projectDetail.description || ('project.summary.description' | translate) }}</p>
        <div class="summary-grid">
          <div>
            <p class="summary-label">{{ 'project.summary.start' | translate }}</p>
            <p class="summary-value">{{ core.formatDateLabel(projectDetail.startDate) }}</p>
          </div>
          <div>
            <p class="summary-label">{{ 'project.summary.end' | translate }}</p>
            <p class="summary-value">{{ core.formatDateLabel(projectDetail.endDate) }}</p>
          </div>
        </div>
        <div class="summary-grid">
          <div class="stat">
            <p class="stat-label">{{ 'project.tasks.total' | translate }}</p>
            <p class="stat-value">{{ taskSummary().total }}</p>
          </div>
          <div class="stat">
            <p class="stat-label">{{ 'project.tasks.pendingCount' | translate }}</p>
            <p class="stat-value">{{ taskSummary().pending }}</p>
          </div>
          <div class="stat">
            <p class="stat-label">{{ 'project.tasks.doneCount' | translate }}</p>
            <p class="stat-value">{{ taskSummary().done }}</p>
          </div>
          <div class="stat">
            <p class="stat-label">{{ 'project.tasks.progress' | translate }}</p>
            <p class="stat-value">{{ taskSummary().progress }}%</p>
          </div>
        </div>
        @if (currentUserId() === projectDetail.ownerId) {
          <div class="project-actions-float">
            <button class="btn primary sm" type="button" (click)="openMemberModal()">
              {{ 'project.members.add' | translate }}
            </button>
            <button
              class="btn ghost icon-only sm"
              type="button"
              (click)="openProjectModal()"
              aria-label="{{ 'project.edit.title' | translate }}"
            >
              <img src="/edit.svg" alt="" width="22" height="22" />
            </button>
          </div>
        }
      </article>
      <article class="card pad stack-md table-card">
        <div class="row row-refresh">
          <div class="row">
            <h2 class="title">{{ 'project.milestones.title' | translate }}</h2>
          </div>
          <button
            class="btn primary icon-only"
            type="button"
            (click)="openMilestoneModal()"
            aria-label="{{ 'form.milestone.submit' | translate }}"
          >
            <img src="/add.svg" alt="" width="24" height="24" />
          </button>
        </div>
        @if (milestoneLoading()) {
          <p class="note">{{ 'project.milestones.loading' | translate }}</p>
        }
        @if (milestoneError(); as error) {
          <p class="error">{{ error | translate }}</p>
        }
        @if (!milestoneLoading() && milestones().length === 0) {
          <p class="note">{{ 'project.milestones.empty' | translate }}</p>
        } @else if (milestones().length > 0) {
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>{{ 'form.milestone.title' | translate }}</th>
                  <th>{{ 'project.summary.start' | translate }}</th>
                  <th>{{ 'form.milestone.description' | translate }}</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                @for (milestone of milestones(); track trackMilestone($index, milestone); let idx = $index) {
                  <tr class="data-row" [style.animationDelay]="(idx * 50) + 'ms'">
                    <td>{{ milestone.title }}</td>
                    <td>{{ core.formatDateLabel(milestone.date) }}</td>
                    <td class="text-wrap">{{ milestone.description || ('common.description.empty' | translate) }}</td>
                  <td class="table-actions">
                    <button
                      class="btn ghost sm"
                      type="button"
                      (click)="openMilestoneAnalysis(milestone.uuid)"
                    >
                      {{ 'project.analysis.button' | translate }}
                    </button>
                    <button
                      class="btn ghost icon-only"
                      type="button"
                      (click)="editMilestone(milestone)"
                        aria-label="{{ 'project.edit.title' | translate }}"
                      >
                        <img src="/edit.svg" alt="" width="20" height="20" />
                      </button>
                      <button
                        class="btn danger icon-only"
                        type="button"
                        (click)="removeMilestone(milestone.uuid)"
                        aria-label="{{ 'common.delete' | translate }}"
                      >
                        <img src="/trash.svg" alt="" width="20" height="20" />
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </article>
    </div>

    <app-task-gantt
      [tasks]="tasks()"
      [milestones]="milestones()"
      [analysis]="projectAnalysis() ?? undefined"
      [loading]="taskLoading()"
      [error]="taskError()"
      (addTask)="openTaskModal()"
      (analyseTask)="openTaskAnalysis($event)"
      (editTask)="editTask($event)"
      (removeTask)="removeTask($event)"
      (updateTaskTimeline)="onTaskTimelineChange($event)"
      (viewSparkline)="openSparkline()"
    ></app-task-gantt>

    @if (showMemberModal() && currentUserId() === projectDetail.ownerId) {
      <div class="modal-backdrop" (click)="closeMemberModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.members.add' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="closeMemberModal()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            <form [formGroup]="memberForm" (ngSubmit)="addMember()" class="member-form">
              <label>{{ 'project.members.form.email' | translate }}</label>
              <div class="member-form-controls">
                <input type="email" formControlName="email" placeholder="person@example.com" />
                <button class="btn primary" type="submit">
                  {{ 'project.members.form.submit' | translate }}
                </button>
              </div>
              @if (memberError(); as error) {
                <p class="error">{{ error | translate }}</p>
              }
              @if (memberSuccess(); as success) {
                <p class="success">{{ success | translate }}</p>
              }
            </form>
          </div>
        </div>
      </div>
    }

    @if (showMemberListModal() && currentUserId() === projectDetail.ownerId) {
      <div class="modal-backdrop" (click)="closeMemberListModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.members.manage' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="closeMemberListModal()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            @if (projectDetail.members && projectDetail.members.length > 0) {
              <ul class="member-list">
                @for (member of projectDetail.members; track trackMember($index, member); let idx = $index) {
                <li class="animated-item" [style.animationDelay]="(idx * 80) + 'ms'">
                  <div>
                    <strong>{{ member.alias }}</strong>
                    <p class="note">{{ member.email }}</p>
                    @if (member.role) {
                      <p class="note">{{ member.role }}</p>
                    }
                  </div>
                  <div class="row">
                    @if (member.id === projectDetail.ownerId) {
                      <span class="pill">{{ 'project.members.owner' | translate }}</span>
                    } @else {
                      <button class="btn danger icon-only" type="button" (click)="removeMember(member.id)" aria-label="{{ 'project.members.remove' | translate }}">
                        <img src="/trash.svg" alt="" width="20" height="20" />
                      </button>
                    }
                  </div>
                </li>
              }
              </ul>
            } @else {
              <p class="note">{{ 'project.members.empty' | translate }}</p>
            }
          </div>
        </div>
      </div>
    }

    @if (showMeta() && projectDetail.additionalFields && (projectDetail.additionalFields | keyvalue).length) {
      <div class="modal-backdrop" (click)="toggleMeta()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.summary.additional' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="toggleMeta()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            <div class="stack-sm">
              @for (field of projectDetail.additionalFields | keyvalue; track field.key; let idx = $index) {
                <p class="note animated-note" [style.animationDelay]="(idx * 60) + 'ms'">
                  <strong>{{ field.key }}:</strong> {{ field.value }}
                </p>
              }
            </div>
          </div>
        </div>
      </div>
    }

    @if (showProjectModal()) {
      <div class="modal-backdrop" (click)="closeProjectModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.edit.title' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="closeProjectModal()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            <app-project-form [data]="projectDetail" (edited)="update($event)" (cancelled)="closeProjectModal()"></app-project-form>
          </div>
        </div>
      </div>
    }

    @if (showMilestoneModal()) {
      <div class="modal-backdrop" (click)="cancelMilestoneEdition()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">
              @if (selectedMilestone()) {
                {{ 'project.edit.title' | translate }} · {{ selectedMilestone()?.title }}
              } @else {
                {{ 'project.milestones.title' | translate }}
              }
            </h2>
            <button class="btn ghost" type="button" (click)="cancelMilestoneEdition()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            <app-milestone-form
              #milestoneCreator
              [data]="selectedMilestone() ?? undefined"
              (submitted)="saveMilestone($event)"
              (cancelled)="cancelMilestoneEdition()"
            ></app-milestone-form>
          </div>
        </div>
      </div>
    }

    @if (showTaskModal()) {
      <div class="modal-backdrop" (click)="cancelTaskEdition()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">
              @if (selectedTask()) {
                {{ 'project.tasks.edit' | translate }} · {{ selectedTask()?.title }}
              } @else {
                {{ 'project.tasks.title' | translate }}
              }
            </h2>
            <button class="btn ghost" type="button" (click)="cancelTaskEdition()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            <app-task-form
              #taskCreator
              [data]="selectedTask() ?? undefined"
              [members]="projectDetail.members ?? []"
              [milestones]="milestones()"
              [projectRange]="{ start: projectDetail.startDate, end: projectDetail.endDate }"
              [defaultAssigneeId]="currentUserId()"
              (submitted)="saveTask($event)"
              (cancelled)="cancelTaskEdition()"
            ></app-task-form>
          </div>
        </div>
      </div>
    }

    @if (showProjectAnalysisModal()) {
      <div class="modal-backdrop" (click)="closeProjectAnalysis()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.analysis.title' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="closeProjectAnalysis()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            @if (analysisLoading()) {
              <p class="note">{{ 'project.analysis.loading' | translate }}</p>
            } @else if (analysisError(); as error) {
              <p class="error">{{ error | translate }}</p>
            } @else if (projectAnalysis(); as projectAnalysisData) {
              <div class="stack-md">
                <p class="muted">
                  {{ 'project.analysis.projectLabel' | translate }}
                  <strong>{{ projectAnalysisData.project.title }}</strong>
                </p>
                @if (projectAnalysisData.milestoneList.length === 0) {
                  <p class="note">{{ 'project.analysis.empty' | translate }}</p>
                } @else {
                  <ul class="analysis-list">
                    @for (milestone of projectAnalysisData.milestoneList; track milestone.milestoneUuid; let idx = $index) {
                      <li class="analysis-item" [style.animationDelay]="(idx * 50) + 'ms'">
                        <div>
                          <strong>{{ milestone.milestoneTitle }}</strong>
                          <p class="note">
                            {{ core.formatDateLabel(milestone.startDate) }} → {{ core.formatDateLabel(milestone.endDate) }}
                          </p>
                        </div>
                        <div class="analysis-metrics">
                          <span class="analysis-chip">
                            {{ 'project.analysis.initial' | translate }}:
                            {{ milestone.initialCompletion | number:'1.0-0' }}%
                          </span>
                          <span
                            class="analysis-chip"
                            [class.analysis-chip--down]="milestone.endCompletion < milestone.initialCompletion"
                          >
                            {{ 'project.analysis.final' | translate }}:
                            {{ milestone.endCompletion | number:'1.0-0' }}%
                          </span>
                        </div>
                      </li>
                    }
                  </ul>
                }
              </div>
            } @else {
              <p class="note">{{ 'project.analysis.empty' | translate }}</p>
            }
          </div>
        </div>
      </div>
    }

    @if (showMilestoneAnalysisModal()) {
      <div class="modal-backdrop" (click)="closeMilestoneAnalysis()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.analysis.milestoneTitle' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="closeMilestoneAnalysis()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            @if (selectedMilestoneAnalysis(); as milestoneAnalysis) {
              <div class="stack-md">
                <div>
                  <h3 class="subtitle">{{ milestoneAnalysis.milestoneTitle }}</h3>
                  <p class="note">
                    {{ core.formatDateLabel(milestoneAnalysis.startDate) }} → {{ core.formatDateLabel(milestoneAnalysis.endDate) }}
                  </p>
                </div>
                <div class="analysis-metrics">
                  <span class="analysis-chip">
                    {{ 'project.analysis.initial' | translate }}:
                    {{ milestoneAnalysis.initialCompletion | number:'1.0-0' }}%
                  </span>
                  <span
                    class="analysis-chip"
                    [class.analysis-chip--down]="milestoneAnalysis.endCompletion < milestoneAnalysis.initialCompletion"
                  >
                    {{ 'project.analysis.final' | translate }}:
                    {{ milestoneAnalysis.endCompletion | number:'1.0-0' }}%
                  </span>
                </div>
                @if (milestoneAnalysis.taskList.length === 0) {
                  <p class="note">{{ 'project.analysis.taskEmpty' | translate }}</p>
                } @else {
                  <ul class="analysis-list">
                    @for (task of milestoneAnalysis.taskList; track task.taskUuid; let idx = $index) {
                      <li class="analysis-item" [style.animationDelay]="(idx * 40) + 'ms'">
                        <strong>{{ task.taskTitle }}</strong>
                        <div class="analysis-metrics">
                          <span class="analysis-chip">
                            {{ 'project.analysis.initial' | translate }}:
                            {{ task.initialCompletion | number:'1.0-0' }}%
                          </span>
                          <span
                            class="analysis-chip"
                            [class.analysis-chip--down]="task.endCompletion < task.initialCompletion"
                          >
                            {{ 'project.analysis.final' | translate }}:
                            {{ task.endCompletion | number:'1.0-0' }}%
                          </span>
                        </div>
                      </li>
                    }
                  </ul>
                }
              </div>
            } @else if (analysisError(); as error) {
              <p class="error">{{ error | translate }}</p>
            } @else {
              <p class="note">{{ 'project.analysis.empty' | translate }}</p>
            }
          </div>
        </div>
      </div>
    }

    @if (showTaskAnalysisModal()) {
      <div class="modal-backdrop" (click)="closeTaskAnalysis()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.analysis.taskTitle' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="closeTaskAnalysis()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            @if (selectedTaskAnalysis(); as taskAnalysis) {
              <div class="stack-md">
                <div>
                  <h3 class="subtitle">{{ taskAnalysis.taskTitle }}</h3>
                  @if (selectedMilestoneAnalysis()) {
                    <p class="note">
                      {{ 'project.analysis.milestoneLabel' | translate }}:
                      {{ selectedMilestoneAnalysis()?.milestoneTitle }}
                    </p>
                  }
                </div>
                <div class="analysis-metrics">
                  <span class="analysis-chip">
                    {{ 'project.analysis.initial' | translate }}:
                    {{ taskAnalysis.initialCompletion | number:'1.0-0' }}%
                  </span>
                  <span
                    class="analysis-chip"
                    [class.analysis-chip--down]="taskAnalysis.endCompletion < taskAnalysis.initialCompletion"
                  >
                    {{ 'project.analysis.final' | translate }}:
                    {{ taskAnalysis.endCompletion | number:'1.0-0' }}%
                  </span>
                </div>
              </div>
            } @else if (analysisError(); as error) {
              <p class="error">{{ error | translate }}</p>
            } @else {
              <p class="note">{{ 'project.analysis.empty' | translate }}</p>
            }
          </div>
        </div>
      </div>
    }

    @if (showSparklineModal()) {
      <div class="modal-backdrop" (click)="closeSparkline()">
        <div class="modal modal-wide" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ 'project.tasks.sparklineTitle' | translate }}</h2>
            <button class="btn ghost" type="button" (click)="closeSparkline()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
          <div class="modal-body">
            <div class="sparkline-card">
              <div class="row row-refresh">
                <h3 class="subtitle">{{ 'project.tasks.sparklineTitle' | translate }}</h3>
                <span class="pill muted">{{ tasks().length }}</span>
              </div>
              @if (tasks().length === 0) {
                <p class="note">{{ 'project.tasks.empty' | translate }}</p>
              } @else {
                <div class="sparkline-grid">
                  @for (task of tasks(); track trackTask($index, task); let idx = $index) {
                    <article class="spark-card" [style.animationDelay]="(idx * 30) + 'ms'">
                      <div class="spark-card-header">
                        <div>
                          <strong>{{ task.title }}</strong>
                          <p class="note">
                            {{ taskStartLabel(task) }} → {{ taskEndLabel(task) }}
                          </p>
                        </div>
                        <span class="spark-progress">{{ taskProgressValue(task) }}%</span>
                      </div>
                      <div class="spark-body">
                        <div class="spark-track">
                          @if (task.startDate) {
                            <span
                              class="spark-fill"
                              [style.left]="taskSparklineStyle(task).left"
                              [style.width]="taskSparklineStyle(task).width"
                            ></span>
                          }
                        </div>
                        <div class="spark-extra">
                          <span>
                            {{ 'project.tasks.durationLabel' | translate:{ weeks: task.durationWeeks || 1 } }}
                          </span>
                          @if (task.assignee) {
                            <span>{{ task.assignee.alias }}</span>
                          }
                        </div>
                      </div>
                    </article>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
  } @else {
    <article class="card pad">
      <p>{{ 'project.selection.placeholder' | translate }}</p>
    </article>
  }
</section>
